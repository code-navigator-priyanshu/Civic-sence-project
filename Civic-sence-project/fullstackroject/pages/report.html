<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Submit Civic Report</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    body{font-family:'Inter',sans-serif;margin:0;background:#fff;}
    .app-header{padding:1rem;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,0.1);}
    .page-content{padding:1rem;background:#f3f4f6;min-height:100vh;}
    .form-input,.form-select,.form-textarea{width:100%;padding:.75rem;margin:.5rem 0;border:1px solid #ccc;border-radius:6px;}
    .submit-btn{width:100%;padding:.75rem;margin-top:1rem;border:none;border-radius:6px;background:#16A34A;color:#fff;font-weight:600;cursor:pointer;}
    .submit-btn:hover{background:#15803D;}
    #report-map{height:260px;width:100%;border-radius:6px;margin-bottom:1rem;background:#ddd;}
    #notification-container{position:fixed;top:1rem;right:1rem;z-index:1000;}
    .toast{padding:.85rem 1rem;border-radius:.5rem;color:#fff;margin-bottom:.5rem;opacity:0;transform:translateX(100%);transition:.4s;}
    .toast.show{opacity:1;transform:translateX(0);}
    .toast.success{background:#22C55E;}
    .toast.error{background:#EF4444;}
  </style>
</head>
<body>
  <div id="notification-container"></div>
  <header class="app-header"><h1>Report an Issue</h1></header>
  <main class="page-content">
    <form id="report-form" enctype="multipart/form-data">
      <div id="report-map"></div>
      <button type="button" id="use-current-location-btn" class="submit-btn" style="background:#374151;">Use My Current Location</button>

      <select id="issue-category" name="category" class="form-select" required>
        <option value="">Select a category...</option>
        <option value="pothole">Pothole</option>
        <option value="streetlight">Streetlight Out</option>
        <option value="waste">Waste Management</option>
        <option value="graffiti">Graffiti</option>
        <option value="other">Other</option>
      </select>

      <input type="text" id="street-address" name="street" class="form-input" placeholder="Street Address" required>
      <input type="text" id="landmark" name="landmark" class="form-input" placeholder="Nearby Landmark (optional)">
      <input type="text" id="city" name="city" class="form-input" placeholder="City" required>
      <input type="text" id="pincode" name="pincode" class="form-input" placeholder="Pincode" required>

      <label for="file-upload">Upload Photo</label>
      <input id="file-upload" name="file" type="file" class="form-input" accept="image/*">
      <img id="image-preview" class="image-preview" alt="Preview"/>

      <textarea id="description" name="description" rows="3" class="form-textarea" placeholder="Add more details..."></textarea>

      <input type="hidden" id="latitude" name="latitude">
      <input type="hidden" id="longitude" name="longitude">
      <input type="hidden" id="reporterName" name="reporterName" value="Logged In User"> 
      <input type="hidden" id="reporterEmail" name="reporterEmail" value="">

      <button type="submit" class="submit-btn">Submit Report</button>
    </form>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const API_URL = 'http://localhost:8080/api/reports';
      const reportForm = document.getElementById('report-form');
      const notif = document.getElementById('notification-container');
      const reporterEmailInput = document.getElementById('reporterEmail');

      const loggedInUserEmail = localStorage.getItem('civic-reporter-user-email');
      if (loggedInUserEmail) reporterEmailInput.value = loggedInUserEmail;
      else { toast("Login required", "error"); setTimeout(() => window.location.href = "login.html", 2000); }

      function toast(msg,type="success"){const el=document.createElement("div");el.className="toast "+type;el.textContent=msg;notif.appendChild(el);requestAnimationFrame(()=>el.classList.add("show"));setTimeout(()=>el.remove(),4000);}

      let map, marker;
      function initMap(){
        map=L.map("report-map").setView([23.16,79.93],13);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);
        marker=L.marker(map.getCenter(),{draggable:true}).addTo(map);
        setCoords(marker.getLatLng());
        marker.on("dragend",e=>setCoords(e.target.getLatLng()));
        map.on("click",e=>{marker.setLatLng(e.latlng);setCoords(e.latlng);});
        setTimeout(()=>map.invalidateSize(),200);
      }
      function setCoords(ll){document.getElementById("latitude").value=ll.lat;document.getElementById("longitude").value=ll.lng;}
      initMap();

      document.getElementById("use-current-location-btn").addEventListener("click",()=>{
        if(!navigator.geolocation){toast("Geolocation not supported","error");return;}
        navigator.geolocation.getCurrentPosition(
          pos=>{const latlng={lat:pos.coords.latitude,lng:pos.coords.longitude};map.setView(latlng,16);marker.setLatLng(latlng);setCoords(latlng);toast("Location set!");},
          ()=>toast("Could not get location","error"),{enableHighAccuracy:true,timeout:10000}
        );
      });

      document.getElementById("file-upload").addEventListener("change",e=>{
        const file=e.target.files[0];const img=document.getElementById("image-preview");
        if(!file){img.style.display="none";img.removeAttribute("src");return;}
        const reader=new FileReader();reader.onload=ev=>{img.src=ev.target.result;img.style.display="block";};reader.readAsDataURL(file);
      });

      // ---- EDIT MODE ----
      const urlParams=new URLSearchParams(window.location.search);
      const reportId=urlParams.get("id");
      if(reportId){ loadReportForEdit(reportId); }

      async function loadReportForEdit(id){
        try{
          const res=await fetch(`${API_URL}/${id}`);
          if(!res.ok) throw new Error("Load failed");
          const r=await res.json();
          document.getElementById("issue-category").value=r.category;
          document.getElementById("street-address").value=r.street;
          document.getElementById("landmark").value=r.landmark||"";
          document.getElementById("city").value=r.city;
          document.getElementById("pincode").value=r.pincode;
          document.getElementById("description").value=r.description||"";
          document.getElementById("latitude").value=r.latitude;
          document.getElementById("longitude").value=r.longitude;
          const latlng={lat:parseFloat(r.latitude),lng:parseFloat(r.longitude)};
          marker.setLatLng(latlng);map.setView(latlng,15);
          reportForm.querySelector("button[type='submit']").textContent="Update Report";
        }catch(err){toast("Could not load report","error");}
      }

      // ---- SUBMIT HANDLER ----
      reportForm.addEventListener("submit",async e=>{
        e.preventDefault();
        if(!reporterEmailInput.value){toast("User email not found","error");return;}

        const btn=reportForm.querySelector("button[type='submit']");
        const old=btn.textContent;btn.disabled=true;btn.textContent=reportId?"Updating...":"Submitting...";

        try{
          const formData=new FormData(reportForm);
          const reportObj={
            category:formData.get("category"),street:formData.get("street"),landmark:formData.get("landmark"),
            city:formData.get("city"),pincode:formData.get("pincode"),description:formData.get("description"),
            latitude:formData.get("latitude"),longitude:formData.get("longitude"),
            reporterName:formData.get("reporterName"),reporterEmail:formData.get("reporterEmail")
          };
          const finalData=new FormData();
          finalData.append("report",new Blob([JSON.stringify(reportObj)],{type:"application/json"}));
          if(formData.get("file")) finalData.append("file",formData.get("file"));

          const method=reportId?"PUT":"POST";
          const url=reportId?`${API_URL}/${reportId}`:API_URL;

          const res=await fetch(url,{method,body:finalData});
          if(!res.ok) throw new Error(reportId?"Update failed":"Submit failed");

          toast(reportId?"Report updated!":"Report submitted!","success");
          reportForm.reset();document.getElementById("image-preview").style.display="none";
          setTimeout(()=>window.location.href="my-reports.html",2000);
        }catch(err){toast(err.message,"error");}
        finally{btn.disabled=false;btn.textContent=old;}
      });
    });
  </script>
</body>
</html>